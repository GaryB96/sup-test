name: Notify cycle boundaries
on:
  schedule:
    - cron: "30 22 * * *"
  workflow_dispatch:
    inputs:
      test_uid:
        description: "Only notify this user id (optional)"
        required: false
      test_email:
        description: "Override destination email (optional)"
        required: false
      force_send:
        description: "Send even if there are no boundaries (1/true)"
        required: false
      pretend_today:
        description: "Pretend today (YYYY-MM-DD) in user's timezone"
        required: false

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm i firebase-admin nodemailer @sendgrid/mail luxon
      - name: Run notifier
        env:
          FIREBASE_SA: ${{ secrets.FIREBASE_SA }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          TEST_UID: ${{ github.event.inputs.test_uid }}
          TEST_EMAIL: ${{ github.event.inputs.test_email }}
          FORCE_SEND: ${{ github.event.inputs.force_send }}
          PRETEND_TODAY: ${{ github.event.inputs.pretend_today }}
        run: node notify.js
